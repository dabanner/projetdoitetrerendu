<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <title>Music Emotions & Genres</title>
  
    <style>
        body {    
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;    
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        svg {
            background-color: #1D1F20;
            padding: 10px;    
        }

        #canvas {
            min-height: 800px;
            min-width: 1400px;
        }

        .tile {
            transition: all 0.3s ease;
        }

        .tile:hover {
            fill: white;
            cursor: pointer;
        }

        #tooltip {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 4px;
            position: absolute;
            pointer-events: none;
            opacity: 0;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 14px;
        }

        #tooltip strong {
            font-size: 16px;
            display: block;
            margin-bottom: 5px;
        }

        #title {
            color: #1D1F20;    
            margin: 20px 0;
            font-size: 28px;
        }

        #container {    
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>

<body>
    <h2 id='title'>Music Emotions & Genres Analysis</h2>
    <div id='container'>
        <svg id='canvas'></svg>
        <div id='tooltip'></div>
    </div>
    
<script>
    const canvas = d3.select('#canvas');
    const tooltip = d3.select('#tooltip');
    
    // Color scale for emotions with fallback colors
    const emotionColors = d3.scaleOrdinal()
        .range([
            '#4ECDC4', '#95A5A6', '#FF69B4', '#FFD93D', '#FF7979',
            '#FF6B6B', '#2C3E50', '#8E44AD', '#3498DB', '#E67E22',
            '#16A085', '#2980B9', '#8E44AD', '#2C3E50', '#F1C40F'
        ]);

    const drawTreeMap = (data) => {
        const hierarchy = d3.hierarchy(data)
            .sum(d => d.value)
            .sort((a, b) => b.value - a.value);

        const treemap = d3.treemap()
            .size([1400, 800])
            .paddingOuter(3)
            .paddingTop(19)
            .paddingInner(2)
            .round(true);

        treemap(hierarchy);

        const nodes = hierarchy.descendants();

        const cell = canvas.selectAll('g')
            .data(nodes)
            .enter()
            .append('g')
            .attr('transform', d => `translate(${d.x0},${d.y0})`);

        cell.append('rect')
            .attr('class', 'tile')
            .attr('width', d => d.x1 - d.x0)
            .attr('height', d => d.y1 - d.y0)
            .attr('fill', d => {
                if (d.depth === 0) return '#1D1F20';
                if (d.depth === 1) return emotionColors(d.data.name);
                return d3.rgb(emotionColors(d.parent.data.name)).brighter(0.3);
            })
            .attr('stroke', '#1D1F20')
            .attr('stroke-width', 1)
            .on('mouseover', (d) => {
                tooltip.style('opacity', 1);
                
                let content = '';
                if (d.depth === 1) {
                    const total = d3.sum(d.children, c => c.value);
                    content = `
                        <strong>${d.data.name}</strong><br>
                        Total Strength: ${total.toLocaleString()}
                    `;
                } else if (d.depth === 2) {
                    content = `
                        <strong>Genre:</strong> ${d.data.name}<br>
                        <strong>Emotion:</strong> ${d.data.emotion}<br>
                        <strong>Strength:</strong> ${d.data.value.toLocaleString()}
                    `;
                }
                
                tooltip.html(content)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            })
            .on('mousemove', () => {
                tooltip.style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            })
            .on('mouseout', () => {
                tooltip.style('opacity', 0);
            });

        // Add text labels
        cell.append('text')
            .attr('x', 5)
            .attr('y', 20)
            .style('fill', 'white')
            .style('font-size', '14px')
            .style('font-weight', d => d.depth === 1 ? 'bold' : 'normal')
            .text(d => {
                const width = d.x1 - d.x0;
                const height = d.y1 - d.y0;
                if (width > 80 && height > 30) {
                    return d.data.name;
                }
                return '';
            });
    };

    // Load data
    fetch('/data/emotion_genre_map.json')
        .then(response => response.json())
        .then(data => {
            console.log('Data loaded:', data);
            drawTreeMap(data);
        })
        .catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('title').textContent = 'Error loading data';
        });
</script>
</body>
</html>